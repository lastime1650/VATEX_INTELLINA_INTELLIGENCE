from requests import post
import json
from typing import Optional, Union 
from intelligence._PARENT import INTELLIGENCE_PARENT
import sqlite3
from datetime import datetime
from threading import Lock, Thread, Event
from concurrent.futures import ThreadPoolExecutor
import time


class INTELLIGENCE_CHILD__MALWAREBAZAAR(INTELLIGENCE_PARENT):
    
    def __init__(self, API_KEY:str):
        super().__init__("malwarebazaar", API_KEY)
        
        #SQLITE3
        self.SQLITE_DB_PATH = (self.my_pwd_dir) + "/resources/malwarebazaar/" + "MALWAREBAZAAR.db"
        self.conn = sqlite3.connect(self.SQLITE_DB_PATH, check_same_thread=False) # 멀티스레드 보장
        self.conn.row_factory = sqlite3.Row # SELECT 시 Dict으로 칼럼명: 값 포맷지원
        self.cursor = self.conn.cursor()
        self._create_tables()
        
        
        Thread(
            target=self._loopupdate,
            daemon=True
        ).start()
        
    def _create_tables(self):
        self.cursor.execute("""
            CREATE TABLE IF NOT EXISTS MALWAREBAZAAR (
            
                Primaryid TEXT  PRIMARY KEY,
                
                sha256_hash TEXT NOT NULL,
                sha3_384_hash TEXT,
                sha1_hash TEXT,
                md5_hash TEXT,
                
                first_seen TEXT,
                
                file_name  TEXT,
                signature  TEXT,
                
                detail_json TEXT DEFAULT NULL
            );
        """)
    def _save_to_db(self, datas:list[dict]):
        '''
        Example "datas" value
        ->
        [... {
        "sha256_hash": "467cf4199c35b0825d8a97b4476aaf611f2a3b4e36b9d29af4fddc13c29ab7fd",
        "sha3_384_hash": "09aacf88cb3a5e0fcc01f38caac5e95f13e6a73e68b4daa3cdfde3888e271a73fe932d9df0ea0a513e7a9eed87f9037a",
        "sha1_hash": "5aa8064df27bdb31092d162a75731fe3a568d3ff",
        "md5_hash": "537a8c74342b8ffca93de0e7fe6e9fd6",
        "first_seen": "2025-11-04 12:59:08 UTC",
        "file_name": "boatnet.x86",
        "signature": "Mirai"
        },
        {
        "sha256_hash": "966202da8b8817a3b3dd30cfd74babda4f216b8d6782e51410c86094f7dd32f0",
        "sha3_384_hash": "4c5f0e919d76fdf260e183c755b0c32ba73ec9491188576b02f66ce6993e1a0e5856c616a98a73e0025c8b6a0ad3c1dd",
        "sha1_hash": "69bd65103f08afd2c3c1a37f9464e752f00dd940",
        "md5_hash": "c5d9de419148fd3baddd6555e06fb8a7",
        "first_seen": "2025-11-04 12:59:07 UTC",
        "file_name": "boatnet.ppc",
        "signature": "Mirai"
        } ...]
        '''
        for data in datas:
            sha256_hash:str = data.get("sha256_hash","")
            sha3_384_hash:str = data.get("sha3_384_hash","")
            sha1_hash:str = data.get("sha1_hash","")
            md5_hash:str = data.get("md5_hash","")
            first_seen:str = data.get("first_seen","")
            file_name:str = data.get("file_name","")
            signature:str = data.get("signature","")
            
            # save to DB
            self.conn.execute("""
                REPLACE INTO MALWAREBAZAAR (
                    Primaryid,
                    sha256_hash,
                    sha3_384_hash,
                    sha1_hash,
                    md5_hash,
                    first_seen,
                    file_name,
                    signature
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                sha256_hash,      # Primaryid
                sha256_hash,
                sha3_384_hash,
                sha1_hash,
                md5_hash,
                first_seen,
                file_name,
                signature
            ))
            self.conn.commit()
    def _save_detail_json_to_db(self, sha256:str, detail_json:dict):
        
        # 1. DB쿼리
        cur = self.conn.cursor()
        cur.execute("SELECT * FROM MALWAREBAZAAR WHERE sha256_hash = ? ", (sha256,))
        rows = [dict(row) for row in cur.fetchall()] # [{...},{...}] 포맷
        if(rows and len(rows) > 0):
            # 이미 이전에 DB에 조회결과가 있는경우
            
            # "detail_json" 값이 존재하지 않은가?
            if(rows[0]["detail_json"] == None):
                # 하지만, "detail_json"키가 NULL/None인 경우 추가
                self.conn.execute("""
                    UPDATE MALWAREBAZAAR
                    SET detail_json = ?
                    WHERE Primaryid = ?
                """, (detail_json, sha256))
                self.conn.commit()
                
        else:
            # 이전 DB조회결과 조차 없는 경우
            
            # 먼저 DB 칼럼에 맞게 row 추가
            self._save_to_db([detail_json])
            
            # 그리고 해당 row에 detail_json값 설정
            self.conn.execute("""
                UPDATE MALWAREBAZAAR
                SET detail_json = ?
                WHERE Primaryid = ?
            """, (json.dumps(detail_json,ensure_ascii=False), sha256))
            self.conn.commit()
    
    
    def _post_to_malwarebazaar(self, keys:dict)->Optional[dict]:
        try:
            response = post("https://mb-api.abuse.ch/api/v1/", headers={"Auth-Key":self.API_KEY}, data=keys)
            if response.status_code != 200:
                return None
            
            return dict(response.json())
        except:
            return None
    
    def _loopupdate(self):
        while(True):
            print("[MalwareBazaar] do loop update")
            
            # query recent for 1hour
            queried = self._post_to_malwarebazaar({"query": "recent_detections", "hours": "1"})
            if(not queried):
                print("[MalwareBazaar] Failed _post_to_malwarebazaar() ")
                time.sleep(60)  # 1분대기
                continue
            
            self._save_to_db(queried["data"])
            
            time.sleep(3601)  # 1시간 1초 대기
            
    def _query_indicator(self, sha256:str)->Optional[list[dict]]:
        # 1. DB쿼리
        cur = self.conn.cursor()
        cur.execute("SELECT * FROM MALWAREBAZAAR WHERE sha256_hash = ? ", (sha256,))
        rows = [dict(row) for row in cur.fetchall()] # [{...},{...}] 포맷
        if(rows and len(rows) > 0):
            return rows
        
        # 2. (1) 실패시 직접 쿼리후 결과 반환 -> DB에 저장
        queried = self._post_to_malwarebazaar({"query": "get_info", "hash": sha256})
        if(not queried):
            return None
        
        
        '''
        [{'sha256_hash': '08a25e1e926752f15b0e2fc79ce07ec41656b6fb55a3da4c0b579a8dc3face0e', 'sha3_384_hash': '8a2b6ae6ce1d84e40115af614e68215308151b41e43509d3998930f6108c58f013b6bf050a4910d306b1b2f2baeddada', 'sha1_hash': '1d41dd89d9d2058a417238179bd9a181757bdd77', 'md5_hash': '55960acbfe37239914e3290f22e3a828', 'first_seen': '2025-10-31 19:40:05', 'last_seen': None, 'file_name': '08a25e1e926752f15b0e2fc79ce07ec41656b6fb55a3d.exe', 'file_size': 33280, 'file_type_mime': 'application/x-dosexec', 'file_type': 'exe', 'reporter': 'abuse_ch', 'origin_country': 'NL', 'anonymous': 0, 'signature': 'AsyncRAT', 'imphash': 'f34d5f2d4577ed6d9ceec516c1f5a744', 'tlsh': 'T131E2D0466FB59236C8978E3D5AF61AA94234E54646B2CF9F5DC4844E2D83304CE03FB3', 'telfhash': None, 'gimphash': None, 'ssdeep': '768:uW1EOrJQLfjGiyNUy8qacx0U+E4w/cgnenX6J:UO1niyNIBcxctw/bJ', 'magika': 'pebin', 'dhash_icon': None, 'trid': ['67.7% (.EXE) Generic CIL Executable (.NET, Mono, etc.) (73123/4/13)', '9.7% (.EXE) Win64 Executable (generic) (10522/11/4)', '6.0% (.DLL) Win32 Dynamic Link Library (generic) (6578/25/2)', '4.6% (.EXE) Win16 NE executable (generic) (5038/12/1)', '4.1% (.EXE) Win32 Executable (generic) (4504/4/1)'], 'comment': 'AsyncRAT C2:\n157.20.182.47:7707', 'archive_pw': None, 'tags': ['AsyncRAT', 'exe', 'RAT'], 'code_sign': None, 'delivery_method': None, 'intelligence': {'clamav': None, 'downloads': '147', 'uploads': '1', 'mail': None}, 'file_information': [{'context': 'cape', 'value': 'https://www.capesandbox.com/analysis/34924/'}], 'ole_information': [], 'yara_rules': [{'rule_name': 'NETexecutableMicrosoft', 'author': 'malware-lu', 'description': None, 'reference': None}, {'rule_name': 'pe_imphash', 'author': None, 'description': None, 'reference': None}, {'rule_name': 'Skystars_Malware_Imphash', 'author': 'Skystars LightDefender', 'description': 'imphash', 'reference': None}, {'rule_name': 'Sus_CMD_Powershell_Usage', 'author': 'XiAnzheng', 'description': 'May Contain(Obfuscated or no) Powershell or CMD Command that can be abused by threat actor(can create FP)', 'reference': None}], 'vendor_intel': {'ANY.RUN': [{'malware_family': 'asyncrat', 'verdict': 'Malicious activity', 'file_name': '08a25e1e926752f15b0e2fc79ce07ec41656b6fb55a3da4c0b579a8dc3face0e.exe', 'date': '2025-10-31 19:09:50', 'analysis_url': 'https://app.any.run/tasks/dd4b9db0-c903-45c3-9221-eeb151278865', 'tags': ['auto-startup', 'asyncrat']}], 'CERT-PL_MWDB': {'detection': None, 'link': 'https://mwdb.cert.pl/sample/08a25e1e926752f15b0e2fc79ce07ec41656b6fb55a3da4c0b579a8dc3face0e/'}, 'YOROI_YOMI': {'detection': 'Malicious File', 'score': '0.77'}, 'vxCube': {'verdict': 'malware2', 'maliciousness': '100', 'behaviour': [{'threat_level': 'malicious', 'rule': 'Enabling autorun by creating a file'}, {'threat_level': 'suspicious', 'rule': 'Connection attempt to an infection source'}, {'threat_level': 'suspicious', 'rule': 'Sending a TCP request to an infection source'}, {'threat_level': 'neutral', 'rule': 'Сreating synchronization primitives'}, {'threat_level': 'neutral', 'rule': 'Using the Windows Management Instrumentation requests'}]}, 'Intezer': {'verdict': 'malicious', 'family_name': None, 'analysis_url': 'https://analyze.intezer.com/analyses/07462675-7559-4f54-8cd2-a198ddaf2ca4?utm_source=MalwareBazaar'}, 'CAPE': {'detection': 'AsyncRAT', 'link': 'https://www.capesandbox.com/analysis/34924/'}, 'Triage': {'malware_family': 'asyncrat', 'score': '10', 'link': 'https://tria.ge/reports/251031-ydyztaax5h/', 'tags': ['family:asyncrat', 'botnet:default', 'rat'], 'signatures': [{'signature': 'AsyncRat', 'score': '10'}, {'signature': 'Asyncrat family', 'score': '10'}, {'signature': 'Async RAT payload', 'score': '9'}, {'signature': 'Drops startup file', 'score': '7'}, {'signature': 'Suspicious use of AdjustPrivilegeToken', 'score': None}], 'malware_config': [{'extraction': 'c2', 'family': 'asyncrat', 'c2': '157.20.182.47:6606'}, {'extraction': 'c2', 'family': 'asyncrat', 'c2': '157.20.182.47:7707'}, {'extraction': 'c2', 'family': 'asyncrat', 'c2': '157.20.182.47:8808'}]}, 'ReversingLabs': {'threat_name': 'ByteCode-MSIL.Backdoor.Asyncrat', 'status': 'MALICIOUS', 'first_seen': '2025-10-31 13:48:29', 'scanner_count': '38', 'scanner_match': '28', 'scanner_percent': '73.68'}, 'Spamhaus_HBL': [{'detection': 'malicious', 'link': 'https://www.spamhaus.org/hbl/'}], 'UnpacMe': [{'sha256_hash': '08a25e1e926752f15b0e2fc79ce07ec41656b6fb55a3da4c0b579a8dc3face0e', 'md5_hash': '55960acbfe37239914e3290f22e3a828', 'sha1_hash': '1d41dd89d9d2058a417238179bd9a181757bdd77', 'detections': [], 'link': 'https://www.unpac.me/results/c5f9ef1c-d29a-4fc1-a6c0-11bca8334616/'}, {'sha256_hash': 'c5f7b37f45e1e22921efb0bffd56c7deb60a1e2d8997bea57c45d0606b735907', 'md5_hash': '16b7a49b5ea7785240ef881c607dee0c', 'sha1_hash': '7b630a110af49ecad7b0c8d84bd5af733cd4c644', 'detections': ['win_asyncrat_w0', 'AsyncRAT', 'asyncrat', 'win_asyncrat_bytecodes', 'win_asyncrat_unobfuscated', 'INDICATOR_SUSPICIOUS_EXE_ASEP_REG_Reverse'], 'link': 'https://www.unpac.me/results/c5f9ef1c-d29a-4fc1-a6c0-11bca8334616/'}], 'VMRay': {'verdict': 'malicious', 'malware_family': 'AsyncRAT', 'report_link': 'https://www.vmray.com/analyses/_mb/08a25e1e9267/report/overview.html'}, 'FileScan-IO': {'verdict': 'SUSPICIOUS', 'threatlevel': '0.5', 'confidence': '1.0', 'report_link': 'https://www.filescan.io/uploads/690510c7a3d1631095245ced/reports/d581b48a-977b-4527-a087-75f3f548a94f/overview'}, 'Kaspersky': {'verdict': 'Malware', 'file_type': 'exe x32', 'first_seen': '2025-10-31T08:57:00Z', 'last_seen': '2025-11-02T17:40:00Z', 'hitscount': 1000, 'report_link': 'https://opentip.kaspersky.com/08a25e1e926752f15b0e2fc79ce07ec41656b6fb55a3da4c0b579a8dc3face0e/results?tab=lookup', 'detections': ['BSS:Trojan.Win32.Generic', 'Trojan.MSIL.Crypt.sb', 'Trojan.MSIL.Agent.sb', 'HEUR:Trojan.MSIL.Cryptos.gen', 'Backdoor.MSIL.Crysan.fb', 'Backdoor.MSIL.Crysan.d', 'Backdoor.MSIL.Crysan.b', 'Trojan.MSIL.Dnoper.sb', 'HEUR:Trojan.Win32.Generic', 'Backdoor.MSIL.Crysan.sb', 'Backdoor.MSIL.Crysan.c', 'Backdoor.MSIL.Agent.sb', 'PDM:Trojan.Win32.Generic']}}, 'comments': None}]
        '''
        
        query_dict = queried["data"][0] if len( queried["data"] )  >= 1 else queried["data"]
        
        # save to db ( with add "detail_json")
        self._save_detail_json_to_db(sha256, query_dict )
        
        
        return query_dict
    
    # override
    def FILE_by_SHA256( self, sha256:str )->Optional[dict]:
        return self._query_indicator(sha256)


'''
< DataBase >

[ Required Columns ]
1. Primaryid
2. sha256_hash
3. sha3_384_hash
4. sha1_hash
5. md5_hash
6. first_seen
7. file_name
8. signature

[ Optional Columns ]
1. detail_json (Default NULL) <TEXT> (MalwareBazaar direct query result json value )

'''